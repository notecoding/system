# C 파일의 리눅스 실행 흐름 <리눅스에서 C파일 실행하기>

## 전처리 (Preprocessing)
C 소스 코드가 컴파일러에 전달되면 가장 먼저 전처리기가 실행됩니다. `#include`, `#define`, `#ifdef` 등의 전처리 지시문들이 처리되어 헤더 파일들이 소스 코드에 포함되고, 매크로들이 실제 코드로 치환됩니다. 이 과정에서 `.c` 파일은 `.i` 파일로 변환됩니다.

## 컴파일 (Compilation)
전처리된 소스 코드가 어셈블리어로 번역되는 단계입니다. 컴파일러는 C 언어 문법을 검사하고, 최적화를 수행한 후 CPU가 이해할 수 있는 어셈블리 명령어로 변환합니다. 이때 `.i` 파일은 `.s` 파일(어셈블리 파일)로 변환됩니다.

## 어셈블리 (Assembly)
어셈블러가 어셈블리 코드를 기계어로 변환하는 단계입니다. CPU가 직접 실행할 수 있는 바이너리 코드가 생성되며, `.s` 파일은 `.o` 파일(오브젝트 파일)로 변환됩니다. 하지만 아직 다른 라이브러리와의 연결은 이루어지지 않은 상태입니다.

## 링킹 (Linking)
링커가 여러 오브젝트 파일들과 라이브러리들을 연결하여 하나의 실행 파일을 만드는 단계입니다. 함수 호출, 전역 변수 참조 등이 실제 메모리 주소로 연결되고, 시스템 라이브러리들이 포함됩니다. 최종적으로 실행 가능한 ELF(Executable and Linkable Format) 파일이 생성됩니다.

## 로더 실행 시작
사용자가 실행 파일을 실행하면 쉘이 `fork()` 시스템 콜을 호출하여 새로운 프로세스를 생성합니다. 이후 `execve()` 시스템 콜을 통해 커널에게 프로그램 실행을 요청합니다.

## ELF 파일 검증
커널은 실행 파일의 ELF 헤더를 읽어 파일 형식이 올바른지, 현재 시스템에서 실행 가능한지 검증합니다. CPU 아키텍처 호환성, 실행 권한 등을 확인하고 문제가 있으면 실행을 거부합니다.

## 메모리 공간 할당
커널은 새로운 프로세스를 위한 가상 메모리 공간을 할당합니다. 텍스트 세그먼트(코드), 데이터 세그먼트(전역 변수), BSS 세그먼트(초기화되지 않은 변수), 힙, 스택 영역이 메모리에 매핑됩니다.

## 프로그램 로딩
ELF 파일의 각 세그먼트가 해당하는 메모리 영역에 로드됩니다. 코드 영역은 읽기 전용으로 설정되고, 데이터 영역은 읽기/쓰기가 가능하도록 설정됩니다. 필요에 따라 동적 링킹이 수행됩니다.

## 동적 링킹 처리
프로그램이 공유 라이브러리를 사용하는 경우, 동적 링커(`ld-linux.so`)가 실행되어 필요한 라이브러리들을 메모리에 로드하고 심볼들을 연결합니다. `libc` 같은 시스템 라이브러리들이 이때 링크됩니다.

## 스택 및 환경 설정
프로세스의 스택이 초기화되고, 명령행 인자(`argc`, `argv`)와 환경 변수들이 스택에 배치됩니다. 프로그램이 실행될 때 필요한 초기 데이터들이 준비됩니다.

## main 함수 실행 준비
C 런타임 라이브러리의 초기화 코드가 먼저 실행됩니다. 전역 변수들이 초기화되고, 생성자 함수들이 호출됩니다. 이후 프로그램의 진입점인 `main` 함수가 호출될 준비가 완료됩니다.

## 프로세스 실행
CPU 스케줄러가 새로운 프로세스에 CPU 시간을 할당하면 `main` 함수부터 프로그램 실행이 시작됩니다. 프로세스는 운영체제의 관리 하에 시분할 방식으로 실행됩니다.

## 시스템 콜 처리
프로그램이 파일 입출력, 메모리 할당, 네트워크 통신 등을 수행할 때는 시스템 콜을 통해 커널에 요청합니다. 커널은 해당 작업을 수행하고 결과를 프로세스에 반환합니다.

## 프로세스 종료
`main` 함수가 종료되거나 `exit()` 함수가 호출되면 프로세스 종료 과정이 시작됩니다. 열린 파일 디스크립터들이 닫히고, 할당된 메모리가 해제되며, 자식 프로세스들에게 신호가 전달됩니다.

## 리소스 정리
커널은 프로세스가 사용했던 모든 시스템 리소스를 정리합니다. 메모리 페이지들이 해제되고, 프로세스 테이블에서 제거되며, 부모 프로세스에게 종료 상태가 전달됩니다.

## 프로세스 소멸
모든 정리 작업이 완료되면 프로세스는 시스템에서 완전히 제거됩니다. 프로세스 ID가 재사용 가능한 상태가 되고, 관련된 모든 커널 자료구조가 해제됩니다.
